<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/index.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <input type="button" id="myInput" value="Publier" onclick="toggleDiv()">
    <div id="myDiv" class="hidden">
        <form id="uploadForm">
            <label for="titre">Titre:</label><br>
            <input type="text" id="titre" name="titre"><br><br>
            <label for="Description">Description:</label><br>
            <textarea class="description" id="description" name="description" autofocus></textarea><br><br>
            <div>
                <input type="radio" id="sport" name="dada" value="1" checked>
                <label for="sport">Sport</label>
                <input type="radio" id="informatique" name="dada" value="2">
                <label for="informatique">Informatique</label>
                <input type="radio" id="Cuisine" name="dada" value="3">
                <label for="Cuisine">Cuisine</label>
                <input type="radio" id="Cinema" name="dada" value="4">
                <label for="Cinema">Cinema</label>
                <input type="radio" id="Lecture" name="dada" value="5">
                <label for="Lecture">Lecture</label>
                <input type="radio" id="Jeux" name="dada" value="6">
                <label for="Jeux">Jeux</label>
                <input type="radio" id="Musique" name="dada" value="7">
                <label for="Musique">Musique</label>

            </div>
            <label for="imageInput">Image:</label><br>
            <input type="file" id="image" name="image" accept="image/png, image/jpeg"><br><br>
            <div id="errorContainer" class="error-container"></div>
            <input type="submit" value="Soumettre" >
        </form>
    </div>
    <form action="/login" method="post">
        <input type="submit" value="Se connecter">
    </form>
    <div class="postContainer" id="postContainer"></div>
    <script src="../java-script/post.js"></script>
    <script>
        $(document).ready(function() {
            var errorContainer = $('#errorContainer'); // Error message container
          
            $('#uploadForm').submit(function(event) {
              event.preventDefault(); // Prevent the default form submission
          
              // Get the form data
              var titre = $('#titre').val();
              var description = $('#description').val();
              var dada = $('input[name=dada]:checked').val();
              var image = $('#image').prop('files')[0];
            
              if (!checkSessionCookie()) {
                alert("You have to be connected to post. Please login.");
                // Create a form dynamically
                var form = $('<form>');
                form.attr('action', '/login');
                form.attr('method', 'get');
                $('body').append(form);
                form.submit();
                return;
            }

              // Perform validation
              if (!titre) {
                showError('Please enter a title.'); // Show the error message
                return;
              }
              
          
              // Clear any previous error message
              clearError();
          
              // Create a new FormData object
              var formData = new FormData();
              // Add form data to FormData object
              formData.append('titre', titre);
              formData.append('description', description);
              formData.append('dada', dada);
              if (image) {
                formData.append('image', image);
              }
          
              // Send the form data to the server using AJAX
              $.ajax({
                url: '/upload', // Update the URL to your server endpoint
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                  // Handle the response from the server
                  console.log(response); // You can do further processing or display a success message
                  post(); // Call the post() function to display the new post
                },
                error: function(xhr, status, error) {
                  // Handle the error
                  console.log(error); // You can display an error message or perform other error handling
                }
              });
            });
            // Function to show the error message
            function showError(message) {
              errorContainer.text(message);
            }
            // Function to clear the error message
            function clearError() {
              errorContainer.text('');
            }

            function checkSessionCookie() {
                var cookieValue = getCookie("session");
                return cookieValue !== null && cookieValue !== "";
            }

            function getCookie(name) {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        return cookie.substring(name.length + 1);
                    }
                }
                return null;
            }
          });      
    </script>
</body>
</html>